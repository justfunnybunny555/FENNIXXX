-- ========================================
-- FENNIXXX AUTHORIZATION MODULE
-- ========================================

-- Roblox Services
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local CoreGui = game:GetService("CoreGui")
local HttpService = game:GetService("HttpService")

-- Module Table
local AuthModule = {}
AuthModule.isAuthorized = false
AuthModule.sessionID = ""

-- KeyAuth Configuration
AuthModule.KeyAuthApp = "FENNIXXX"
AuthModule.KeyAuthOwnerID = "edcEgR58Gp"
AuthModule.KeyAuthVersion = "1.0"
AuthModule.KeyAuthURL = "https://keyauth.win/api/1.2/"

-- Функция получения HWID
function AuthModule.getHWID()
    local hwid = game:GetService("RbxAnalyticsService"):GetClientId()
    return hwid
end

-- Функция инициализации KeyAuth
function AuthModule.initKeyAuth()
    local success, response = pcall(function()
        return request({
            Url = AuthModule.KeyAuthURL,
            Method = "POST",
            Headers = {
                ["Content-Type"] = "application/x-www-form-urlencoded"
            },
            Body = "type=init&ver=" .. AuthModule.KeyAuthVersion .. "&name=" .. AuthModule.KeyAuthApp .. "&ownerid=" .. AuthModule.KeyAuthOwnerID
        })
    end)
    if not success then
        warn("KeyAuth init request failed: " .. tostring(response))
        return false, "Connection failed"
    end
    if response.StatusCode == 200 then
        local decodeSuccess, data = pcall(function()
            return HttpService:JSONDecode(response.Body)
        end)
        if decodeSuccess then
            if data.success then
                AuthModule.sessionID = data.sessionid
                return true, "Initialized"
            else
                warn("KeyAuth init failed: " .. (data.message or "Unknown error"))
                return false, data.message or "Init failed"
            end
        else
            warn("KeyAuth init decode failed: " .. response.Body)
            return false, "Invalid response"
        end
    else
        warn("KeyAuth init status code: " .. response.StatusCode)
        return false, "Server error: " .. response.StatusCode
    end
end

-- Функция проверки лицензии
function AuthModule.verifyLicense(key)
    if not AuthModule.sessionID or AuthModule.sessionID == "" then
        local initSuccess, initMsg = AuthModule.initKeyAuth()
        if not initSuccess then
            return false, "Failed to initialize: " .. initMsg
        end
        wait(0.5)
    end
    local hwid = AuthModule.getHWID()
    local success, response = pcall(function()
        return request({
            Url = AuthModule.KeyAuthURL,
            Method = "POST",
            Headers = {
                ["Content-Type"] = "application/x-www-form-urlencoded"
            },
            Body = "type=license&key=" .. HttpService:UrlEncode(key) ..
            "&sessionid=" .. AuthModule.sessionID ..
            "&name=" .. AuthModule.KeyAuthApp ..
            "&ownerid=" .. AuthModule.KeyAuthOwnerID ..
            "&hwid=" .. hwid
        })
    end)
    if not success then
        warn("KeyAuth license request failed: " .. tostring(response))
        return false, "Connection failed"
    end
    if response.StatusCode == 200 then
        local decodeSuccess, data = pcall(function()
            return HttpService:JSONDecode(response.Body)
        end)
        if decodeSuccess then
            if data.success then
                local exp = "Lifetime"
                if data.info and data.info.subscriptions then
                    for _, sub in pairs(data.info.subscriptions) do
                        if sub.expiry and sub.expiry ~= "lifetime" then
                            exp = os.date("%m/%d/%Y %H:%M", tonumber(sub.expiry))
                        end
                    end
                end
                return true, "License verified! Expires: " .. exp
            else
                return false, data.message or "Invalid license key"
            end
        else
            warn("KeyAuth license decode failed: " .. response.Body)
            return false, "Invalid response from server"
        end
    else
        warn("KeyAuth license status code: " .. response.StatusCode .. " Body: " .. response.Body)
        return false, "Server error: " .. response.StatusCode
    end
end

-- Создание GUI для ввода ключа
function AuthModule.createAuthGUI(onAuthorizedCallback)
    local authGui = Instance.new("ScreenGui")
    authGui.Name = "KeyAuthGUI"
    authGui.IgnoreGuiInset = true
    authGui.ResetOnSpawn = false
    authGui.Parent = CoreGui

    local darkBackground = Instance.new("Frame")
    darkBackground.Size = UDim2.new(1, 0, 1, 0)
    darkBackground.Position = UDim2.new(0, 0, 0, 0)
    darkBackground.BackgroundColor3 = Color3.fromRGB(5, 5, 15)
    darkBackground.BorderSizePixel = 0
    darkBackground.BackgroundTransparency = 0.05
    darkBackground.Parent = authGui

    local bgGradient = Instance.new("UIGradient", darkBackground)
    bgGradient.Color = ColorSequence.new{
        ColorSequenceKeypoint.new(0, Color3.fromRGB(10, 5, 30)),
        ColorSequenceKeypoint.new(0.5, Color3.fromRGB(5, 5, 15)),
        ColorSequenceKeypoint.new(1, Color3.fromRGB(15, 10, 35))
    }
    bgGradient.Rotation = 45
    
    local particles = {}
    for i = 1, 40 do
        local particle = Instance.new("Frame")
        particle.Size = UDim2.new(0, math.random(2, 6), 0, math.random(2, 6))
        particle.Position = UDim2.new(math.random(0, 100) / 100, 0, math.random(-30, 130) / 100, 0)
        particle.BackgroundColor3 = Color3.new(0, math.random(200, 255) / 255, math.random(200, 255) / 255)
        particle.BackgroundTransparency = math.random(50, 80) / 100
        particle.BorderSizePixel = 0
        particle.Parent = darkBackground
        local particleCorner = Instance.new("UICorner", particle)
        particleCorner.CornerRadius = UDim.new(1, 0)
        table.insert(particles, {
            frame = particle,
            speed = math.random(10, 35) / 1000,
            drift = math.random(-10, 10) / 1000,
            glow = math.random(0, 1) > 0.5
        })
    end
    
    local particleConnection
    particleConnection = RunService.RenderStepped:Connect(function()
        for _, particle in ipairs(particles) do
            local currentPos = particle.frame.Position
            local newY = currentPos.Y.Scale + particle.speed
            local newX = currentPos.X.Scale + particle.drift
            if newY > 1.3 then
                newY = -0.2
                newX = math.random(0, 100) / 100
            end
            if newX > 1.2 then newX = -0.1 end
            if newX < -0.2 then newX = 1.1 end
            particle.frame.Position = UDim2.new(newX, 0, newY, 0)
            if particle.glow then
                local time = tick()
                particle.frame.BackgroundTransparency = 0.5 + math.sin(time * 3) * 0.25
            end
        end
    end)

    local authFrame = Instance.new("Frame")
    authFrame.Size = UDim2.new(0, 500, 0, 440)
    authFrame.Position = UDim2.new(0.5, -250, 0.5, -220)
    authFrame.BackgroundColor3 = Color3.fromRGB(12, 12, 22)
    authFrame.BorderSizePixel = 0
    authFrame.BackgroundTransparency = 0.05
    authFrame.Parent = authGui
    
    local authCorner = Instance.new("UICorner", authFrame)
    authCorner.CornerRadius = UDim.new(0, 18)
    
    local authStroke = Instance.new("UIStroke", authFrame)
    authStroke.Color = Color3.fromRGB(0, 255, 255)
    authStroke.Thickness = 3
    authStroke.Transparency = 0.1
    
    local glowTween = TweenService:Create(authStroke, TweenInfo.new(2.5, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut, -1, true), {
        Color = Color3.fromRGB(255, 0, 255)
    })
    glowTween:Play()
    
    local authGradient = Instance.new("UIGradient", authFrame)
    authGradient.Color = ColorSequence.new{
        ColorSequenceKeypoint.new(0, Color3.fromRGB(20, 20, 35)),
        ColorSequenceKeypoint.new(0.5, Color3.fromRGB(12, 12, 22)),
        ColorSequenceKeypoint.new(1, Color3.fromRGB(18, 18, 30))
    }
    authGradient.Rotation = 135
    
    local logoFrame = Instance.new("Frame")
    logoFrame.Size = UDim2.new(0, 90, 0, 90)
    logoFrame.Position = UDim2.new(0.5, -45, 0, 25)
    logoFrame.BackgroundColor3 = Color3.fromRGB(0, 255, 255)
    logoFrame.BorderSizePixel = 0
    logoFrame.Parent = authFrame
    
    local logoCorner = Instance.new("UICorner", logoFrame)
    logoCorner.CornerRadius = UDim.new(0, 18)
    
    local logoGradient = Instance.new("UIGradient", logoFrame)
    logoGradient.Color = ColorSequence.new{
        ColorSequenceKeypoint.new(0, Color3.fromRGB(0, 255, 255)),
        ColorSequenceKeypoint.new(1, Color3.fromRGB(255, 0, 255))
    }
    logoGradient.Rotation = 45
    
    local logoText = Instance.new("TextLabel")
    logoText.Size = UDim2.new(1, 0, 1, 0)
    logoText.Text = "F"
    logoText.TextColor3 = Color3.fromRGB(255, 255, 255)
    logoText.TextSize = 52
    logoText.Font = Enum.Font.GothamBold
    logoText.BackgroundTransparency = 1
    logoText.Parent = logoFrame
    
    local logoTween = TweenService:Create(logoFrame, TweenInfo.new(1.8, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut, -1, true), {
        Rotation = 3
    })
    logoTween:Play()
    
    local titleLabel = Instance.new("TextLabel")
    titleLabel.Size = UDim2.new(1, 0, 0, 50)
    titleLabel.Position = UDim2.new(0, 0, 0, 125)
    titleLabel.Text = "FENNIXXX AUTHENTICATION"
    titleLabel.TextColor3 = Color3.fromRGB(0, 255, 255)
    titleLabel.TextSize = 22
    titleLabel.Font = Enum.Font.GothamBold
    titleLabel.BackgroundTransparency = 1
    titleLabel.Parent = authFrame
    
    local subtitleLabel = Instance.new("TextLabel")
    subtitleLabel.Size = UDim2.new(1, 0, 0, 30)
    subtitleLabel.Position = UDim2.new(0, 0, 0, 170)
    subtitleLabel.Text = "Enter your license key to continue"
    subtitleLabel.TextColor3 = Color3.fromRGB(180, 180, 220)
    subtitleLabel.TextSize = 13
    subtitleLabel.Font = Enum.Font.Gotham
    subtitleLabel.BackgroundTransparency = 1
    subtitleLabel.Parent = authFrame
    
    local hwidLabel = Instance.new("TextLabel")
    hwidLabel.Size = UDim2.new(1, -40, 0, 20)
    hwidLabel.Position = UDim2.new(0, 20, 0, 205)
    hwidLabel.Text = "HWID: " .. AuthModule.getHWID()
    hwidLabel.TextColor3 = Color3.fromRGB(140, 140, 180)
    hwidLabel.TextSize = 10
    hwidLabel.Font = Enum.Font.GothamMedium
    hwidLabel.BackgroundTransparency = 1
    hwidLabel.TextXAlignment = Enum.TextXAlignment.Left
    hwidLabel.Parent = authFrame
    
    local copyHWIDBtn = Instance.new("TextButton")
    copyHWIDBtn.Size = UDim2.new(0, 70, 0, 25)
    copyHWIDBtn.Position = UDim2.new(1, -90, 0, 203)
    copyHWIDBtn.BackgroundColor3 = Color3.fromRGB(0, 200, 200)
    copyHWIDBtn.Text = "COPY"
    copyHWIDBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    copyHWIDBtn.TextSize = 11
    copyHWIDBtn.Font = Enum.Font.GothamBold
    copyHWIDBtn.BorderSizePixel = 0
    copyHWIDBtn.Parent = authFrame
    
    local copyCorner = Instance.new("UICorner", copyHWIDBtn)
    copyCorner.CornerRadius = UDim.new(0, 8)
    
    local copyGradient = Instance.new("UIGradient", copyHWIDBtn)
    copyGradient.Color = ColorSequence.new{
        ColorSequenceKeypoint.new(0, Color3.fromRGB(0, 220, 220)),
        ColorSequenceKeypoint.new(1, Color3.fromRGB(0, 180, 180))
    }
    
    copyHWIDBtn.MouseButton1Click:Connect(function()
        setclipboard(AuthModule.getHWID())
        copyHWIDBtn.Text = "COPIED"
        copyHWIDBtn.BackgroundColor3 = Color3.fromRGB(0, 255, 100)
        wait(1.5)
        copyHWIDBtn.Text = "COPY"
        copyHWIDBtn.BackgroundColor3 = Color3.fromRGB(0, 200, 200)
    end)
    
    local keyBox = Instance.new("TextBox")
    keyBox.Size = UDim2.new(0, 420, 0, 50)
    keyBox.Position = UDim2.new(0.5, -210, 0, 245)
    keyBox.BackgroundColor3 = Color3.fromRGB(20, 20, 35)
    keyBox.Text = ""
    keyBox.PlaceholderText = "KEYAUTH-XXXXX-XXXXX-XXXXX"
    keyBox.PlaceholderColor3 = Color3.fromRGB(100, 100, 140)
    keyBox.TextColor3 = Color3.fromRGB(255, 255, 255)
    keyBox.TextSize = 15
    keyBox.Font = Enum.Font.GothamBold
    keyBox.BorderSizePixel = 0
    keyBox.ClearTextOnFocus = false
    keyBox.Parent = authFrame
    
    local keyBoxCorner = Instance.new("UICorner", keyBox)
    keyBoxCorner.CornerRadius = UDim.new(0, 12)
    
    local keyBoxStroke = Instance.new("UIStroke", keyBox)
    keyBoxStroke.Color = Color3.fromRGB(80, 80, 120)
    keyBoxStroke.Thickness = 2.5
    keyBoxStroke.Transparency = 0.3
    
    keyBox.Focused:Connect(function()
        TweenService:Create(keyBoxStroke, TweenInfo.new(0.3), {
            Color = Color3.fromRGB(0, 255, 255),
            Transparency = 0
        }):Play()
    end)
    
    keyBox.FocusLost:Connect(function()
        TweenService:Create(keyBoxStroke, TweenInfo.new(0.3), {
            Color = Color3.fromRGB(80, 80, 120),
            Transparency = 0.3
        }):Play()
    end)
    
    local submitBtn = Instance.new("TextButton")
    submitBtn.Size = UDim2.new(0, 210, 0, 48)
    submitBtn.Position = UDim2.new(0.5, -105, 0, 315)
    submitBtn.BackgroundColor3 = Color3.fromRGB(0, 220, 220)
    submitBtn.Text = "VERIFY KEY"
    submitBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    submitBtn.TextSize = 17
    submitBtn.Font = Enum.Font.GothamBold
    submitBtn.BorderSizePixel = 0
    submitBtn.Parent = authFrame
    
    local submitBtnCorner = Instance.new("UICorner", submitBtn)
    submitBtnCorner.CornerRadius = UDim.new(0, 12)
    
    local submitBtnStroke = Instance.new("UIStroke", submitBtn)
    submitBtnStroke.Color = Color3.fromRGB(0, 255, 255)
    submitBtnStroke.Thickness = 2.5
    
    local submitGradient = Instance.new("UIGradient", submitBtn)
    submitGradient.Color = ColorSequence.new{
        ColorSequenceKeypoint.new(0, Color3.fromRGB(0, 240, 240)),
        ColorSequenceKeypoint.new(1, Color3.fromRGB(200, 0, 255))
    }
    submitGradient.Rotation = 45
    
    local statusLabel = Instance.new("TextLabel")
    statusLabel.Size = UDim2.new(1, 0, 0, 25)
    statusLabel.Position = UDim2.new(0, 0, 1, -60)
    statusLabel.Text = ""
    statusLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
    statusLabel.TextSize = 12
    statusLabel.Font = Enum.Font.GothamBold
    statusLabel.BackgroundTransparency = 1
    statusLabel.Parent = authFrame
    
    local getKeyBtn = Instance.new("TextButton")
    getKeyBtn.Size = UDim2.new(0, 170, 0, 28)
    getKeyBtn.Position = UDim2.new(0.5, -85, 0, 373)
    getKeyBtn.BackgroundColor3 = Color3.fromRGB(60, 60, 100)
    getKeyBtn.Text = "Get License Key"
    getKeyBtn.TextColor3 = Color3.fromRGB(200, 200, 240)
    getKeyBtn.TextSize = 12
    getKeyBtn.Font = Enum.Font.GothamBold
    getKeyBtn.BorderSizePixel = 0
    getKeyBtn.Parent = authFrame
    
    local getKeyCorner = Instance.new("UICorner", getKeyBtn)
    getKeyCorner.CornerRadius = UDim.new(0, 10)
    
    getKeyBtn.MouseButton1Click:Connect(function()
        setclipboard("https://keyauth.win/panel/" .. AuthModule.KeyAuthApp .. "/licenses")
        getKeyBtn.Text = "Link Copied!"
        getKeyBtn.BackgroundColor3 = Color3.fromRGB(0, 200, 100)
        wait(2)
        getKeyBtn.Text = "Get License Key"
        getKeyBtn.BackgroundColor3 = Color3.fromRGB(60, 60, 100)
    end)

    local function verifyKey()
        local key = keyBox.Text
        if key == "" or #key < 10 then
            statusLabel.Text = "Please enter a valid key"
            statusLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
            local originalPos = authFrame.Position
            for i = 1, 3 do
                TweenService:Create(authFrame, TweenInfo.new(0.05),{Position = originalPos + UDim2.new(0, 10, 0, 0)}):Play()
                wait(0.05)
                TweenService:Create(authFrame, TweenInfo.new(0.05),{Position = originalPos - UDim2.new(0, 10, 0, 0)}):Play()
                wait(0.05)
            end
            authFrame.Position = originalPos
            return
        end
        
        submitBtn.Text = "VERIFYING..."
        submitBtn.BackgroundColor3 = Color3.fromRGB(120, 120, 160)
        statusLabel.TextColor3 = Color3.fromRGB(200, 200, 240)
        
        local loading = true
        spawn(function()
            local dotCount = 0
            while loading do
                statusLabel.Text = "Checking license" .. string.rep(".", (dotCount % 4))
                dotCount = dotCount + 1
                wait(0.5)
            end
        end)
        
        local verifySuccess, success, message = pcall(function()
            return AuthModule.verifyLicense(key)
        end)
        loading = false
        
        if verifySuccess and success then
            AuthModule.isAuthorized = true
            statusLabel.Text = message
            statusLabel.TextColor3 = Color3.fromRGB(0, 255, 100)
            logoText.Text = "✓"
            TweenService:Create(logoFrame, TweenInfo.new(0.5), {BackgroundColor3 = Color3.fromRGB(0, 255, 100)}):Play()
            TweenService:Create(submitBtn, TweenInfo.new(0.5), {BackgroundColor3 = Color3.fromRGB(0, 255, 100)}):Play()
            wait(2)
            particleConnection:Disconnect()
            TweenService:Create(authFrame, TweenInfo.new(0.8, Enum.EasingStyle.Back, Enum.EasingDirection.In), {Size = UDim2.new(0, 0, 0, 0), Position = UDim2.new(0.5, 0, 0.5, 0), BackgroundTransparency = 1}):Play()
            TweenService:Create(darkBackground, TweenInfo.new(0.8), {BackgroundTransparency = 1}):Play()
            for _, particle in ipairs(particles) do
                TweenService:Create(particle.frame, TweenInfo.new(0.8), {BackgroundTransparency = 1}):Play()
            end
            wait(0.8)
            authGui:Destroy()
            
            -- Вызываем callback после успешной авторизации
            if onAuthorizedCallback then
                onAuthorizedCallback()
            end
        else
            submitBtn.Text = "VERIFY KEY"
            submitBtn.BackgroundColor3 = Color3.fromRGB(0, 220, 220)
            statusLabel.Text = message or "Verification failed"
            statusLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
            local originalPos = authFrame.Position
            for i = 1, 3 do
                TweenService:Create(authFrame, TweenInfo.new(0.05),{Position = originalPos + UDim2.new(0, 10, 0, 0)}):Play()
                wait(0.05)
                TweenService:Create(authFrame, TweenInfo.new(0.05),{Position = originalPos - UDim2.new(0, 10, 0, 0)}):Play()
                wait(0.05)
            end
            authFrame.Position = originalPos
        end
    end
    
    submitBtn.MouseButton1Click:Connect(verifyKey)
    keyBox.FocusLost:Connect(function(enterPressed)
        if enterPressed then
            verifyKey()
        end
    end)
    
    submitBtn.MouseEnter:Connect(function()
        TweenService:Create(submitBtn, TweenInfo.new(0.2), {Size = UDim2.new(0, 220, 0, 51)}):Play()
    end)
    
    submitBtn.MouseLeave:Connect(function()
        if submitBtn.Text == "VERIFY KEY" then
            TweenService:Create(submitBtn, TweenInfo.new(0.2), {Size = UDim2.new(0, 210, 0, 48)}):Play()
        end
    end)
    
    authFrame.Size = UDim2.new(0, 0, 0, 0)
    authFrame.Position = UDim2.new(0.5, 0, 0.5, 0)
    authFrame.BackgroundTransparency = 1
    TweenService:Create(authFrame, TweenInfo.new(1, Enum.EasingStyle.Back, Enum.EasingDirection.Out), {
        Size = UDim2.new(0, 500, 0, 440),
        Position = UDim2.new(0.5, -250, 0.5, -220),
        BackgroundTransparency = 0.05
    }):Play()
end

return AuthModule
