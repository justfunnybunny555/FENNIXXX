-- Roblox services
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local CoreGui = game:GetService("CoreGui")

-- Aimbot Configuration
local Config = {
    Enabled = true,
    HitPart = "Closest Point",
    FOVSize = 35, -- Used for target selection radius, but FOV circle is invisible
    Prediction = {
        X = 0,
        Y = 0,
        Z = 0
    },
    Keybind = Enum.KeyCode.C
}

-- Spread Controller Configuration
local SpreadMod = { 
    BulletSpread = { 
        Enabled = true, 
        Amount = 60 
    } 
}

-- Configuration for fire rate
local Delay = 0.1

-- List of allowed parts for aimbot targeting (excluding hands and feet)
local allowedPartsList = {
    "Head", "UpperTorso", "LowerTorso", "HumanoidRootPart"
}

-- Create FOV Circle for aimbot (invisible)
local FOVCircle = Drawing.new("Circle")
FOVCircle.Visible = false -- FOV circle is not visible

-- Cache for the current aimbot target
local cachedTarget = nil

-- Function to get the closest part of a player's character for aimbot
local function getClosestPart(character)
    local bestPart, bestDist = nil, math.huge
    local mousePos = UserInputService:GetMouseLocation()

    for _, partName in ipairs(allowedPartsList) do
        local part = character:FindFirstChild(partName)
        if part then
            local screenPos, onScreen = Camera:WorldToViewportPoint(part.Position)
            if onScreen then
                local partPos = Vector2.new(screenPos.X, screenPos.Y)
                local dist = (mousePos - partPos).Magnitude
                if dist < bestDist then
                    bestPart, bestDist = part, dist
                end
            end
        end
    end
    return bestPart
end

-- Function to update aimbot target selection
local function updateTarget()
    local mousePos = UserInputService:GetMouseLocation()
    local radius = Config.FOVSize * 5

    local bestPart, bestDist = nil, math.huge
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character then
            local part = Config.HitPart == "Closest Point" and getClosestPart(player.Character) or player.Character:FindFirstChild("Head")
            if part then
                local screenPos, onScreen = Camera:WorldToViewportPoint(part.Position)
                if onScreen then
                    local partPos = Vector2.new(screenPos.X, screenPos.Y)
                    local dist = (mousePos - partPos).Magnitude
                    if dist < bestDist and dist <= radius then
                        bestPart, bestDist = part, dist
                    end
                end
            end
        end
    end
    cachedTarget = bestPart
end

-- Function to apply prediction offset for aimbot
local function applyPrediction(cf, offset)
    return cf * CFrame.new(offset.X, offset.Y, offset.Z)
end

-- Toggle aimbot with keybind
UserInputService.InputBegan:Connect(function(input, processed)
    if processed then return end
    if input.KeyCode == Config.Keybind then
        Config.Enabled = not Config.Enabled
        print("Silent Aimbot is now", Config.Enabled and "Enabled" or "Disabled")
    end
end)

-- Hook mouse behavior for aimbot
local mt = getrawmetatable(game)
local oldIndex = mt.__index
setreadonly(mt, false)
mt.__index = newcclosure(function(obj, prop)
    if Config.Enabled and obj:IsA("Mouse") and (prop == "Hit" or prop == "Target") then
        local target = cachedTarget
        if target then
            local predMultiplier = Vector3.new(Config.Prediction.X, Config.Prediction.Y, Config.Prediction.Z)
            local offset = target.Velocity * predMultiplier
            return prop == "Hit" and applyPrediction(target.CFrame, offset) or target
        end
    end
    return oldIndex(obj, prop)
end)
setreadonly(mt, true)

-- Update aimbot target every few frames
local frameCounter = 0
RunService.RenderStepped:Connect(function()
    if not Config.Enabled then return end
    frameCounter = frameCounter + 1
    if frameCounter % 3 == 0 then -- Update every 3 frames
        updateTarget()
    end
end)

-- Automatically activate tool when a valid aimbot target is found
RunService.Heartbeat:Connect(function()
    if not Config.Enabled then return end
    local target = cachedTarget
    local currentTool = LocalPlayer.Character and LocalPlayer.Character:FindFirstChildOfClass("Tool")
    if target and currentTool and currentTool:FindFirstChild("Activate") then
        currentTool:Activate()
    end
end)

-- Hook math.random for bullet spread modification
local oldRandom
oldRandom = hookfunction(math.random, function(...)
    local args = {...}
    if checkcaller() then return oldRandom(...) end -- Bypass for Roblox internal calls
    if (#args == 0) or (args[1] == -0.05 and args[2] == 0.05) or (args[1] == -0.1) or (args[1] == -0.05) then
        if SpreadMod.BulletSpread.Enabled then
            return oldRandom(...) * (SpreadMod.BulletSpread.Amount / 100)
        end
    end
    return oldRandom(...)
end)

-- Create main ScreenGui for spread controller
local gui = Instance.new("ScreenGui")
gui.IgnoreGuiInset = true
gui.ResetOnSpawn = false
gui.Name = "SpreadUI"
gui.Parent = CoreGui

-- Main UI setup for spread controller
local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 320, 0, 160)
frame.Position = UDim2.new(0.5, -160, 0.8, -80)
frame.AnchorPoint = Vector2.new(0, 0)
frame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
frame.BorderSizePixel = 0
frame.Parent = gui
Instance.new("UICorner", frame).CornerRadius = UDim.new(0, 12)

local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, -20, 0, 30)
title.Position = UDim2.new(0, 10, 0, 5)
title.Text = "Spread Controller"
title.TextColor3 = Color3.fromRGB(255, 255, 255)
title.TextSize = 16
title.Font = Enum.Font.GothamBold
title.BackgroundTransparency = 1
title.TextXAlignment = Enum.TextXAlignment.Left
title.Parent = frame

local valueLabel = Instance.new("TextLabel")
valueLabel.Size = UDim2.new(1, -20, 0, 20)
valueLabel.Position = UDim2.new(0, 10, 0, 45)
valueLabel.Text = "Spread Amount: " .. SpreadMod.BulletSpread.Amount
valueLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
valueLabel.TextSize = 14
valueLabel.Font = Enum.Font.Gotham
valueLabel.BackgroundTransparency = 1
valueLabel.TextXAlignment = Enum.TextXAlignment.Left
valueLabel.Parent = frame

local slider = Instance.new("Frame")
slider.Size = UDim2.new(0, 260, 0, 8)
slider.Position = UDim2.new(0, 20, 0, 90)
slider.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
slider.BorderSizePixel = 0
slider.Parent = frame
Instance.new("UICorner", slider).CornerRadius = UDim.new(0, 4)

local knob = Instance.new("Frame")
knob.Size = UDim2.new(0, 16, 0, 24)
knob.Position = UDim2.new(SpreadMod.BulletSpread.Amount / 100, -6, -0.8, 0)
knob.BackgroundColor3 = Color3.fromRGB(255, 120, 50)
knob.BorderSizePixel = 0
knob.Parent = slider
Instance.new("UICorner", knob).CornerRadius = UDim.new(1, 0)

local watermark = Instance.new("TextLabel")
watermark.Size = UDim2.new(1, -30, 0, 20)
watermark.Position = UDim2.new(0, 0, 0, 10)
watermark.Text = ".gg/traced"
watermark.TextColor3 = Color3.fromRGB(255, 255, 255)
watermark.TextSize = 12
watermark.Font = Enum.Font.Gotham
watermark.BackgroundTransparency = 1
watermark.TextXAlignment = Enum.TextXAlignment.Right
watermark.Parent = frame

local dragHandle = Instance.new("TextLabel")
dragHandle.Size = UDim2.new(0, 60, 0, 20)
dragHandle.Position = UDim2.new(1, -70, 1, -30)
dragHandle.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
dragHandle.BorderSizePixel = 0
dragHandle.Text = "DRAG"
dragHandle.TextColor3 = Color3.fromRGB(255, 255, 255)
dragHandle.TextSize = 14
dragHandle.Font = Enum.Font.GothamBold
dragHandle.Parent = frame
Instance.new("UICorner", dragHandle).CornerRadius = UDim.new(0, 4)

-- UI resizing logic for spread controller
local draggingResize = false
local initialMouseY
local initialSize
local minScale, maxScale = 0.9, 1.2

dragHandle.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        draggingResize = true
        initialMouseY = input.Position.Y
        initialSize = frame.Size
    end
end)

UserInputService.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        draggingResize = false
    end
end)

local function UpdateUIElements()
    slider.Size = UDim2.new(0, frame.Size.X.Offset - 60, 0, 8)
    knob.Position = UDim2.new(SpreadMod.BulletSpread.Amount / 100, -6, -0.8, 0)
    watermark.Position = UDim2.new(0, 0, 0, 10)
    dragHandle.Position = UDim2.new(1, -70, 1, -30)
    title.Size = UDim2.new(1, -20, 0, 30)
    valueLabel.Size = UDim2.new(1, -20, 0, 20)
end

UserInputService.InputChanged:Connect(function(input)
    if draggingResize and input.UserInputType == Enum.UserInputType.MouseMovement then
        local deltaY = input.Position.Y - initialMouseY
        local scale = math.clamp(1 + deltaY / 300, minScale, maxScale)
        frame.Size = UDim2.new(
            initialSize.X.Scale,
            math.clamp(initialSize.X.Offset * scale, initialSize.X.Offset * minScale, initialSize.X.Offset * maxScale),
            initialSize.Y.Scale,
            math.clamp(initialSize.Y.Offset * scale, initialSize.Y.Offset * minScale, initialSize.Y.Offset * maxScale)
        )
        UpdateUIElements()
    end
end)

-- Slider interaction for spread controller
local dragging = false
knob.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
    end
end)

UserInputService.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = false
    end
end)

UserInputService.InputChanged:Connect(function(input)
    if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
        local relX = math.clamp((input.Position.X - slider.AbsolutePosition.X) / slider.AbsoluteSize.X, 0, 1)
        knob.Position = UDim2.new(relX, -6, -0.8, 0)
        local spreadValue = math.floor(relX * 100)
        SpreadMod.BulletSpread.Amount = spreadValue
        valueLabel.Text = "Spread Amount: " .. spreadValue
    end
end)

-- Toggle spread controller UI with Insert key
UserInputService.InputBegan:Connect(function(input, gp)
    if not gp and input.KeyCode == Enum.KeyCode.Insert then
        frame.Visible = not frame.Visible
    end
end)

-- Fire rate modification
LocalPlayer.CharacterAdded:Connect(function(character)
    character.ChildAdded:Connect(function(Tool)
        for _, connection in pairs(getconnections(Tool.Activated)) do
            local Info = debug.getinfo(connection.Function)
            for Index = 1, Info.nups do
                local value, name = debug.getupvalue(connection.Function, Index)
                if type(value) == "number" then
                    debug.setupvalue(connection.Function, Index, Delay)
                end
            end
        end
    end)
end)
